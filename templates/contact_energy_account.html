<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>New Zealand Electricity</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
</head>
<body class="container-md">
    <div class="row alert justify-content-center">
        <div class="col-md-6">
            <a href="/get_data_contact">Back</a>
            <h1>Get usage</h1>
            {% if failed_reason %}
                <p class="text-danger">Error: {{ failed_reason }}</p>
            {% endif %}
            <p class="text-danger" id="ajax-error-msg"></p>
            <div class="progress-stacked my-4">
                <div class="progress" role="progressbar" style="width: 0"
                     id="progress-success"
                >
                    <div class="progress-bar bg-success">0%</div>
                </div>
                <div class="progress" role="progressbar" style="width: 0"
                     id="progress-failed"
                >
                    <div class="progress-bar bg-danger">0%</div>
                </div>
                <div class="progress" role="progressbar" style="width: 100%"
                     id="progress-unhandled"
                >
                    <div class="progress-bar" style="background-color: lightgray">100%</div>
                </div>
            </div>
            <form action="/get_data_contact/usage" method="post" id="get_usage">
                {% csrf_token %}
                {{ account_form.as_p }}
                <div class="text-center">
                    <input type="submit" value="Start" class="btn btn-primary">
                </div>
            </form>
            <p class="fw-bold mt-4">About account number and contract ID</p>
            <p>
                If you have multiple properties in this account, please select the
                correct account number and contract ID corresponding to the property
                to look up.
            </p>
            <ul>
                <li>
                    Account number can be found at
                    <a href="https://myaccount.contact.co.nz/home">Contact Energy</a>
                    personal account's home page, starting with "Acct." below your name.
                </li>
                <li>Contract ID cannot be found, and you need to try each to distinguish.</li>
            </ul>
        </div>
    </div>
<script>
    $('#get_usage').submit(function(event) {
        event.preventDefault(); // Prevent the default form submission

        const form = $(this);
        const action_target = form.attr('action'); // Get the form's action URL
        const error_msg = document.getElementById("ajax-error-msg");
        error_msg.textContent = "";
        $.ajax({
            type: 'POST',
            url: action_target,
            data: form.serialize(), // Serialize the form data
            success: function() {
                error_msg.textContent = "Done.";
            },
            error: function(response) {
                error_msg.textContent = response.responseText;
            }
        });

        let unhandled = 100;
        let success = 0;
        let failed = 0;
        const progress_success = document.getElementById("progress-success");
        const progress_failed = document.getElementById("progress-failed");
        const progress_unhandled = document.getElementById("progress-unhandled");
        const get_data_progress = setInterval(() => {
            $.ajax({
                type: 'POST',
                url: '/get_data_contact/progress',
                data: form.serialize(),
                success: function (response) {
                    success = response['success'];
                    failed = response['failed'];
                    unhandled = response['unhandled'];
                    progress_success.style.width = `${success}%`;
                    progress_failed.style.width = `${failed}%`;
                    progress_unhandled.style.width = `${unhandled}%`;
                    progress_success.firstElementChild.textContent = `${success}%`;
                    progress_failed.firstElementChild.textContent = `${failed}%`;
                    progress_unhandled.firstElementChild.textContent = `${unhandled}%`;
                    if (unhandled === 0) {
                        clearInterval(get_data_progress);
                    }
                },
                error: function() {
                    clearInterval(get_data_progress);
                }
            });
        }, 1000);
    });
</script>
</body>
</html>
